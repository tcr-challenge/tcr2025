<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TCR ‚Äì YEAR END CHALLENGE 2025</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
/* --- PH·∫¶N LOGIN --- */
#login-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: radial-gradient(circle at top, #111111, #4a0000, #000000);
    z-index: 9999; display: flex; justify-content: center; align-items: center;
}
.login-box {
    background: rgba(0, 0, 0, 0.85); padding: 40px; border-radius: 20px;
    border: 2px solid #ffeb3b; box-shadow: 0 0 30px rgba(255, 235, 59, 0.3);
    text-align: center; width: 320px; backdrop-filter: blur(10px);
}
.login-box h2 { color: #ffeb3b; margin-bottom: 25px; text-transform: uppercase; letter-spacing: 2px; }
.login-box input {
    width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 10px;
    border: 1px solid #ffeb3b; background: rgba(255, 255, 255, 0.1); color: #fff;
    outline: none; text-align: center; font-size: 16px;
}
.login-box button {
    width: 100%; padding: 12px; border-radius: 10px; border: none;
    background: #ffeb3b; color: #000; font-weight: bold; cursor: pointer;
    text-transform: uppercase; transition: 0.3s;
}
.login-box button:hover { background: #fff; box-shadow: 0 0 15px #ffeb3b; }

/* HI·ªÜU ·ª®NG HOA ƒê√ÄO R∆†I */
.sakura {
    position: fixed; top: -10%; z-index: 9999; pointer-events: none;
    background: #ffb7c5; opacity: 0.8;
    animation: fall linear infinite, sway ease-in-out infinite;
}
@keyframes fall { 0% { top: -10%; } 100% { top: 110%; } }
@keyframes sway { 0%, 100% { transform: translateX(0) rotate(0deg); } 50% { transform: translateX(80px) rotate(180deg); } }

/* C·∫•u tr√∫c ch√≠nh */
* { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important; }
body { margin: 0; min-height: 100vh; color: #ffffff; overflow-x: hidden; position: relative; background-color: #000000; }
body::before { content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at top, #111111, #4a0000, #001a4a); z-index: -2; }
#bg-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-size: cover; background-position: center; background-repeat: no-repeat; opacity: 0.2; pointer-events: none; }

header { text-align: center; padding: 15px 18px 5px 18px; width: 100%; }
header h1 { font-size: 40px; margin: 0; font-weight: 900; text-transform: uppercase; letter-spacing: 3px; color: #ffffff; text-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000, 0 0 30px #ff0000; }
header h2 { font-size: 20px; margin: 5px 0; color: #ffffff; font-weight: 800; text-transform: uppercase; text-shadow: 0 0 5px #ff0000, 0 0 10px #ff0000; }
header h3 { font-size: 24px; margin: 5px 0; color: #ffeb3b; font-weight: 900; text-transform: uppercase; text-shadow: 0 0 15px rgba(255, 235, 59, 0.8); letter-spacing: 1px; }

.team-outside-info { text-align: center; margin-bottom: 5px; }
.team-outside-info h2 { font-size: 65px; margin: 0; color: #ffeb3b; text-shadow: 0 0 25px rgba(255, 235, 59, 0.9); font-weight: 950; }

.week-dropdown-container { display: flex; justify-content: center; margin-bottom: 25px; position: relative; z-index: 100; align-items: center; gap: 15px; }
.dropbtn { padding: 10px 40px; border-radius: 35px; border: 3px solid #ffeb3b; background: #ffeb3b; color: #000000; font-weight: 950; transition: all 0.3s ease; text-transform: uppercase; font-size: 22px; display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 350px; animation: neon-glow 2s infinite ease-in-out; letter-spacing: 1px; }
.week-subtext { font-size: 14px; font-weight: 600; text-transform: none; margin-top: 2px; opacity: 0.9; }

@keyframes neon-glow { 0% { box-shadow: 0 0 5px #ffeb3b; } 50% { box-shadow: 0 0 20px #ffeb3b, 0 0 40px #ffeb3b; } 100% { box-shadow: 0 0 5px #ffeb3b; } }
.nav-arrow { background: none; border: 2px solid #ffeb3b; color: #ffeb3b; font-size: 30px; cursor: pointer; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; font-weight: bold; }

main { display: flex; justify-content: center; padding: 5px; }
.team-display-container { display: flex; align-items: flex-start; background: rgba(0, 0, 0, 0.8); padding: 25px; border-radius: 45px; border: 2px solid #ffeb3b; box-shadow: 0 0 40px rgba(255, 235, 59, 0.3); backdrop-filter: blur(15px); width: 1450px; height: 880px; justify-content: space-between; position: relative; }
.leader-column { display: flex; flex-direction: column; align-items: center; gap: 10px; width: 250px; }
.leader-name-tag { font-size: 18px; font-weight: 800; color: #ffeb3b; text-transform: uppercase; min-height: 50px; text-shadow: 0 0 10px #ffeb3b; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; }
.leader-frame { width: 100%; height: 650px; border: 3px solid #ffeb3b; border-radius: 40px; overflow: hidden; }
.leader-frame img { width: 100%; height: 100%; object-fit: cover; }

.stats-table-container { flex-grow: 1; margin: 0 20px; display: flex; flex-direction: column; align-items: center; overflow: hidden; }
table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; border: 1px solid rgba(255, 235, 59, 0.4); border-radius: 5px; overflow: hidden; margin-bottom: 15px; }
th, td { border: 1px solid rgba(255, 235, 59, 0.2); padding: 7px 4px; text-align: center; }
th { background: rgba(255, 235, 59, 0.3); color: #ffeb3b; font-weight: bold; font-size: 15px; }
.leader-name-cell { font-weight: 900 !important; color: #ffeb3b !important; text-transform: uppercase; text-shadow: 0 0 8px #ffeb3b; }
.row-total-week { background: rgba(255, 235, 59, 0.2); font-weight: 900; font-size: 22px; color: #ffffff; text-shadow: 0 0 8px #ff0000; }
.row-total-month { background: rgba(255, 235, 59, 0.25); font-weight: 950; font-size: 30px; color: #ffffff; text-shadow: 0 0 15px #ff0000; }
.month-value-highlight { font-size: 40px; }
.col-member-total { font-weight: bold; color: #ffeb3b; font-size: 16px; }

/* CH·ªàNH S·ª¨A V·ªä TR√ç TEAM SELECTOR L√äN TR√äN */
.controls-area { display: flex; flex-direction: column; align-items: center; gap: 10px; width: 100%; margin-bottom: 20px; }
.team-selector { display: flex; gap: 20px; background: rgba(255,255,255,0.1); padding: 12px 30px; border-radius: 40px; border: 1px solid rgba(255,235,59,0.3); align-items: center; }
.team-option { cursor: pointer; font-weight: bold; color: #cccccc; display: flex; align-items: center; gap: 5px; transition: all 0.3s ease; padding: 5px 10px; border-radius: 20px; }
.team-option input { display: none; }
.team-option:has(input:checked) { color: #ffeb3b; transform: scale(1.3); text-shadow: 0 0 10px #ffeb3b; }

/* Corner Controls */
.corner-controls { position: absolute; bottom: 25px; left: 35px; display: flex; align-items: center; gap: 10px; z-index: 10; background: rgba(0,0,0,0.5); padding: 8px 15px; border-radius: 30px; border: 1px solid rgba(255,235,59,0.3); }
.icon-btn { cursor: pointer; color: #ffeb3b; font-size: 18px; display: flex; align-items: center; justify-content: center; opacity: 0.8; transition: 0.3s; }
.icon-btn:hover { opacity: 1; transform: scale(1.1); }

.music-info-wrapper { display: flex; align-items: center; gap: 8px; border-left: 1px solid rgba(255,235,59,0.3); padding-left: 10px; }
.song-container { width: 100px; overflow: hidden; position: relative; height: 16px; }
#song-name { font-size: 11px; color: #ffeb3b; white-space: nowrap; position: absolute; animation: marquee 8s linear infinite; font-weight: 500; }
@keyframes marquee { 0% { left: 100%; } 100% { left: -100%; } }

.music-wave { width: 25px; height: 15px; display: flex; align-items: flex-end; gap: 2px; }
.music-wave span { width: 2px; background: #ffeb3b; height: 3px; }
.playing span { animation: wave 1s infinite ease-in-out; }
@keyframes wave { 0%, 100% { height: 3px; } 50% { height: 12px; } }
.music-wave span:nth-child(2) { animation-delay: 0.2s; }
.music-wave span:nth-child(3) { animation-delay: 0.4s; }

@media screen and (max-width: 768px) {
    header h1 { font-size: 18px; }
    header h2 { font-size: 11px; }
    header h3 { font-size: 12px; }
    .team-outside-info h2 { font-size: 30px; }
    .dropbtn { min-width: 220px; font-size: 12px; padding: 8px 15px; }
    .team-display-container { flex-direction: row; flex-wrap: wrap; width: 100%; height: auto; padding: 10px 5px; justify-content: center; gap: 5px; }
    .leader-column { width: 45%; order: 1; }
    .leader-frame { height: 90px; width: 90px; border-radius: 15px; }
    .stats-table-container { width: 100%; margin: 10px 0; order: 2; overflow-x: hidden; }
    table { font-size: 8.5px; }
    .corner-controls { bottom: 10px; left: 10px; scale: 0.8; transform-origin: left bottom; }
}
</style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <h2>LOGIN TCR</h2>
        <input type="text" id="username" placeholder="User Name">
        <input type="password" id="password" placeholder="Password">
        <button onclick="checkLogin()">ƒêƒÉng Nh·∫≠p</button>
        <p id="login-err" style="color: #ff5252; font-size: 12px; margin-top: 10px; display: none;">Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u!</p>
    </div>
</div>

<div id="bg-overlay"></div>
<header>
    <h1>TH∆Ø·ª¢NG C√ÅT RUNNERS - TCR</h1>
    <h2 id="week-title">B·∫¢NG T·ªîNG K·∫æT TH·ª¨ TH√ÅCH</h2>
    <h3>YEAR-END RUNNING CHALLENGE 2025</h3>
</header>

<div class="week-dropdown-container">
    <button class="nav-arrow" onclick="changeWeek(-1)">‚ùÆ</button>
    <div class="dropbtn">
        <span id="selected-week-text">üö© TU·∫¶N 1: KH·ªûI ƒê·ªòNG</span>
        <span id="selected-week-dates" class="week-subtext">(23/12/2025 ƒë·∫øn 28/12/2025)</span>
    </div>
    <button class="nav-arrow" onclick="changeWeek(1)">‚ùØ</button>
</div>

<div class="team-outside-info"><h2 id="display-team-name">TEAM A</h2></div>

<main>
    <div class="team-display-container">
        <div class="leader-column">
            <div class="leader-name-tag"><span>‚≠ê</span><span id="name-leader1">LEADER 1</span></div>
            <div class="leader-frame"><img id="img-leader1" src=""></div>
        </div>
        <div class="stats-table-container">
            <div class="controls-area">
                <div class="team-selector">
                    <label class="team-option"><input type="radio" name="teamSelect" value="TEAM A" checked onchange="switchTeam(this.value)"><span>TEAM A</span></label>
                    <label class="team-option"><input type="radio" name="teamSelect" value="TEAM B" onchange="switchTeam(this.value)"><span>TEAM B</span></label>
                    <label class="team-option"><input type="radio" name="teamSelect" value="TEAM C" onchange="switchTeam(this.value)"><span>TEAM C</span></label>
                    <label class="team-option"><input type="radio" name="teamSelect" value="TEAM D" onchange="switchTeam(this.value)"><span>TEAM D</span></label>
                </div>
            </div>
            
            <table id="statsTable"><thead id="tableHead"></thead><tbody id="tableBody"></tbody></table>
        </div>
        <div class="leader-column">
            <div class="leader-name-tag"><span>‚≠ê</span><span id="name-leader2">LEADER 2</span></div>
            <div class="leader-frame"><img id="img-leader2" src=""></div>
        </div>

        <div class="corner-controls">
            <div class="icon-btn" onclick="document.getElementById('bgInput').click()" title="ƒê·ªïi n·ªÅn">üñºÔ∏è</div>
            <div id="media-player-UI" class="music-info-wrapper">
                <div class="icon-btn" id="playPauseBtn" onclick="toggleMusic()">‚ñ∂Ô∏è</div>
                <div class="song-container">
                    <div id="song-name">ƒêang t·∫£i nh·∫°c...</div>
                </div>
                <div class="music-wave" id="musicWave"><span></span><span></span><span></span></div>
            </div>
        </div>

        <input type="file" id="bgInput" accept="image/*" style="display:none" onchange="changeBackground(this)">
        <audio id="bgMusic" onplay="updateUI(true)" onpause="updateUI(false)" onended="playRandomSong()"></audio>
    </div>
</main>

<script>
// DANH S√ÅCH NH·∫†C TRONG TH∆Ø M·ª§C music/
const songList = [
    { title: "B√†i h√°t 1", file: "music/song1.mp3" },
    { title: "B√†i h√°t 2", file: "music/song2.mp3" },
    { title: "B√†i h√°t 3", file: "music/song3.mp3" },
    { title: "Nh·∫°c T·∫øt S√¥i ƒê·ªông", file: "music/tet.mp3" }
];

function playRandomSong() {
    const audio = document.getElementById('bgMusic');
    const nameText = document.getElementById('song-name');
    const randomIndex = Math.floor(Math.random() * songList.length);
    const randomSong = songList[randomIndex];
    audio.src = randomSong.file;
    nameText.innerText = randomSong.title;
    audio.load();
    audio.play().catch(e => console.log("Ph√°t nh·∫°c th·∫•t b·∫°i."));
}

function updateUI(isPlaying) {
    const btn = document.getElementById('playPauseBtn');
    const wave = document.getElementById('musicWave');
    if (isPlaying) { btn.innerText = '‚è∏Ô∏è'; wave.classList.add('playing'); } 
    else { btn.innerText = '‚ñ∂Ô∏è'; wave.classList.remove('playing'); }
}

function toggleMusic() {
    const audio = document.getElementById('bgMusic');
    if (audio.paused) { if(!audio.src) playRandomSong(); else audio.play(); } 
    else { audio.pause(); }
}

function createSakura() {
    const sakura = document.createElement('div');
    sakura.className = 'sakura';
    const shapes = ['50% 0 50% 50%', '50% 50% 0 50%', '20% 80% 20% 80%'];
    sakura.style.borderRadius = shapes[Math.floor(Math.random() * shapes.length)];
    const size = Math.random() * 7 + 6 + 'px';
    sakura.style.width = size;
    sakura.style.height = (parseFloat(size) * (Math.random() * 0.5 + 0.8)) + 'px';
    sakura.style.left = Math.random() * 100 + 'vw';
    const fallDuration = Math.random() * 5 + 7 + 's';
    sakura.style.animationDuration = `${fallDuration}, ${Math.random() * 2 + 3}s`;
    sakura.style.animationDelay = `-${Math.random() * 10}s`;
    document.body.appendChild(sakura);
    setTimeout(() => { sakura.remove(); }, fallDuration * 1000);
}
setInterval(createSakura, 500);

const _u = "VENS"; const _p = "MQ==";
function checkLogin() {
    const u = document.getElementById('username').value;
    const p = document.getElementById('password').value;
    if (btoa(u.toUpperCase()) === _u && btoa(p) === _p) {
        document.getElementById('login-overlay').style.display = 'none';
        sessionStorage.setItem('tcr_auth', 'true');
        playRandomSong();
    } else { document.getElementById('login-err').style.display = 'block'; }
}
if (sessionStorage.getItem('tcr_auth') === 'true') document.getElementById('login-overlay').style.display = 'none';

let currentTeam = "TEAM A", currentWeek = 1;
const WEEK_DATES = { 1: ["23/12", "24/12", "25/12", "26/12", "27/12", "28/12"], 2: ["29/12", "30/12", "31/12", "01/01", "02/01", "03/01", "04/01"], 3: ["05/01", "06/01", "07/01", "08/01", "09/01", "10/01", "11/01"], 4: ["12/01", "13/01", "14/01", "15/01", "16/01", "17/01", "18/01"], 5: ["19/01", "20/01", "21/01", "22/01"] };
const WEEK_TITLES = { 1: "üö© TU·∫¶N 1: KH·ªûI ƒê·ªòNG", 2: "‚ö° TU·∫¶N 2: TƒÇNG T·ªêC", 3: "üî• TU·∫¶N 3: B·ª®T PH√Å", 4: "üèÜ TU·∫¶N 4: V·ªÄ ƒê√çCH", 5: "üëë TU·∫¶N 5: VINH QUANG" };
const WEEK_RANGE_TEXT = { 1: "(23/12/2025 ƒë·∫øn 28/12/2025)", 2: "(29/12/2025 ƒë·∫øn 04/01/2026)", 3: "(05/01/2026 ƒë·∫øn 11/01/2026)", 4: "(12/01/2026 ƒë·∫øn 18/01/2026)", 5: "(19/01/2026 ƒë·∫øn 22/01/2026)" };
const DRIVE_FILE_URL = "https://docs.google.com/spreadsheets/d/1SUHiQixRuR2qZ4bFMfUW-T6PdHyEhrsv/export?format=xlsx";

function changeWeek(s) { let n = currentWeek + s; if (n >= 1 && n <= 5) switchWeek(n); }
function switchWeek(w) { currentWeek = w; document.getElementById('selected-week-text').innerText = WEEK_TITLES[w]; document.getElementById('selected-week-dates').innerText = WEEK_RANGE_TEXT[w]; renderUI(); }
function switchTeam(v) { currentTeam = v; document.getElementById('display-team-name').innerText = v; renderUI(); }
function formatFileName(n) { return n.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/ƒë/g, "d").replace(/ƒê/g, "D").replace(/\s+/g, "").toLowerCase(); }
function formatValue(n) { return (n===0 || isNaN(n)) ? "0" : n.toLocaleString('vi-VN'); }

function renderUI() {
    const key = "data_" + currentTeam + "_W" + currentWeek;
    const stored = localStorage.getItem(key);
    const thead = document.getElementById('tableHead'), tbody = document.getElementById('tableBody');
    const dates = WEEK_DATES[currentWeek];
    thead.innerHTML = `<tr><th>H·ªç T√™n</th>${dates.map(d=>`<th>${d}</th>`).join('')}<th>T·ªîNG</th></tr>`;
    if (!stored) { tbody.innerHTML = "<tr><td colspan='"+(dates.length+2)+"'>ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>"; return; }
    const data = JSON.parse(stored);
    tbody.innerHTML = ''; let totalW = 0;
    for (let i = 0; i < 7; i++) {
        let name = (data.names[i] || "Th√†nh vi√™n").replace('‚≠ê','').trim();
        if(i<2) { document.getElementById(`name-leader${i+1}`).innerText = name.toUpperCase(); document.getElementById(`img-leader${i+1}`).src = `img/${formatFileName(name)}.png`; }
        let mSum = 0;
        for (let j = 0; j < 2; j++) {
            const row = document.createElement('tr');
            if (j === 0) row.innerHTML = `<td rowspan="2" class="${i<2?'leader-name-cell':''}">${i<2?'‚≠ê':''}${name}</td>`;
            for (let k = 0; k < dates.length; k++) { let v = (data.values[i] && data.values[i][j]) ? (data.values[i][j][k] || 0) : 0; row.innerHTML += `<td>${formatValue(v)}</td>`; mSum += v; }
            if (j === 0) row.innerHTML += `<td rowspan="2" class="col-member-total">${formatValue(0)}</td>`;
            tbody.appendChild(row);
        }
        tbody.lastChild.previousSibling.querySelector('.col-member-total').innerText = formatValue(mSum);
        totalW += mSum;
    }
    tbody.innerHTML += `<tr class="row-total-week"><td colspan="${dates.length+2}">T·ªîNG TU·∫¶N: ${formatValue(totalW)} KM</td></tr>`;
    tbody.innerHTML += `<tr class="row-total-month"><td colspan="${dates.length+2}">T·ªîNG TH√ÅNG: <span class="month-value-highlight">${formatValue(data.monthTotal)} KM</span></td></tr>`;
}

async function loadData() {
    try {
        const res = await fetch(DRIVE_FILE_URL);
        const buf = await res.arrayBuffer();
        const wb = XLSX.read(new Uint8Array(buf), { type: 'array' });
        const teams = ["TEAM A", "TEAM B", "TEAM C", "TEAM D"];
        [1,2,3,4,5].forEach(w => {
            const sh = wb.Sheets["TU·∫¶N " + w]; if(!sh) return;
            const json = XLSX.utils.sheet_to_json(sh, {header: 1});
            teams.forEach(t => {
                let idx = json.findIndex(r => r[0] && r[0].toString().toUpperCase() === t);
                if(idx !== -1) {
                    let d = { names: [], values: [], monthTotal: 0 };
                    const numDays = WEEK_DATES[w].length;
                    for(let i=0; i<7; i++) {
                        let r = json[idx+1+i*2]; if(!r) break;
                        d.names.push(r[0]); d.values.push([r.slice(1,1+numDays), json[idx+2+i*2].slice(1,1+numDays)]);
                    }
                    localStorage.setItem(`data_${t}_W${w}`, JSON.stringify(d));
                }
            });
        });
        renderUI();
    } catch (e) { console.error(e); }
}

function changeBackground(i) {
    if (i.files[0]) {
        const r = new FileReader();
        r.onload = e => { document.getElementById('bg-overlay').style.backgroundImage = `url(${e.target.result})`; localStorage.setItem('bg_tcr', e.target.result); };
        r.readAsDataURL(i.files[0]);
    }
}

window.onload = () => {
    const bg = localStorage.getItem('bg_tcr');
    if(bg) document.getElementById('bg-overlay').style.backgroundImage = `url(${bg})`;
    loadData(); switchWeek(1);
};
</script>
</body>
</html>
